<?php
/**
 * RequestDesk Product Sync Template
 *
 * @var \RequestDesk\Blog\Block\Adminhtml\Sync\Index $block
 */

$isConfigured = $block->isApiConfigured();
$productCount = $block->getTotalProductCount();
$endpointUrl = $block->getEndpointUrl();
?>

<div class="requestdesk-sync-container">
    <div class="admin__page-section">
        <div class="admin__page-section-title">
            <span class="title"><?= $block->escapeHtml(__('Sync Products to RequestDesk')) ?></span>
        </div>
        <div class="admin__page-section-content">
            <p><?= $block->escapeHtml(__('Export your Magento products to RequestDesk\'s AI knowledge base for analysis and content generation.')) ?></p>

            <?php if (!$isConfigured): ?>
                <div class="message message-warning">
                    <strong><?= $block->escapeHtml(__('API Not Configured')) ?></strong>
                    <p><?= $block->escapeHtml(__('Please configure your RequestDesk API key before syncing products.')) ?></p>
                    <a href="<?= $block->escapeUrl($block->getConfigUrl()) ?>" class="action-secondary">
                        <?= $block->escapeHtml(__('Configure API')) ?>
                    </a>
                </div>
            <?php else: ?>
                <div class="admin__field">
                    <div class="admin__field-label">
                        <label><?= $block->escapeHtml(__('Products to Sync')) ?></label>
                    </div>
                    <div class="admin__field-value">
                        <strong><?= (int)$productCount ?></strong> <?= $block->escapeHtml(__('enabled, visible products')) ?>
                    </div>
                </div>

                <div class="admin__field">
                    <div class="admin__field-label">
                        <label><?= $block->escapeHtml(__('RequestDesk Endpoint')) ?></label>
                    </div>
                    <div class="admin__field-value">
                        <?= $block->escapeHtml($endpointUrl) ?>
                    </div>
                </div>

                <div class="actions-toolbar">
                    <div class="primary">
                        <button type="button"
                                id="requestdesk-test-btn"
                                class="action-secondary"
                                onclick="testConnection()">
                            <span><?= $block->escapeHtml(__('Test Connection')) ?></span>
                        </button>

                        <button type="button"
                                id="requestdesk-sync-btn"
                                class="action-primary"
                                onclick="syncProducts()">
                            <span><?= $block->escapeHtml(__('Sync All Products')) ?></span>
                        </button>
                    </div>
                </div>

                <div id="sync-result" class="message" style="display: none; margin-top: 20px;"></div>
            <?php endif; ?>
        </div>
    </div>

    <div class="admin__page-section" style="margin-top: 20px;">
        <div class="admin__page-section-title">
            <span class="title"><?= $block->escapeHtml(__('What Gets Synced')) ?></span>
        </div>
        <div class="admin__page-section-content">
            <ul style="margin-left: 20px;">
                <li><?= $block->escapeHtml(__('Product names and descriptions')) ?></li>
                <li><?= $block->escapeHtml(__('SKUs and pricing information')) ?></li>
                <li><?= $block->escapeHtml(__('Category assignments')) ?></li>
                <li><?= $block->escapeHtml(__('Product images and media')) ?></li>
                <li><?= $block->escapeHtml(__('Meta keywords and attributes')) ?></li>
            </ul>
        </div>
    </div>

    <div class="admin__page-section" style="margin-top: 20px;">
        <div class="admin__page-section-title">
            <span class="title"><?= $block->escapeHtml(__('Use Cases')) ?></span>
        </div>
        <div class="admin__page-section-content">
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px; padding: 15px; background: #f5f5f5; border-radius: 4px;">
                    <h4 style="margin-top: 0;"><?= $block->escapeHtml(__('Product Analysis')) ?></h4>
                    <p><?= $block->escapeHtml(__('Get AI-powered GEO/AEO/AIO analysis on your product content for improved SEO.')) ?></p>
                </div>
                <div style="flex: 1; min-width: 250px; padding: 15px; background: #f5f5f5; border-radius: 4px;">
                    <h4 style="margin-top: 0;"><?= $block->escapeHtml(__('Blog Generation')) ?></h4>
                    <p><?= $block->escapeHtml(__('Generate topic-based blog posts that reference your products naturally.')) ?></p>
                </div>
                <div style="flex: 1; min-width: 250px; padding: 15px; background: #f5f5f5; border-radius: 4px;">
                    <h4 style="margin-top: 0;"><?= $block->escapeHtml(__('AI Responses')) ?></h4>
                    <p><?= $block->escapeHtml(__('Use product knowledge to power AI chatbots and customer service.')) ?></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function testConnection() {
        var btn = document.getElementById('requestdesk-test-btn');
        var resultDiv = document.getElementById('sync-result');

        btn.disabled = true;
        btn.querySelector('span').textContent = '<?= $block->escapeJs(__('Testing...')) ?>';

        fetch('<?= $block->escapeUrl($block->getTestUrl()) ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            resultDiv.style.display = 'block';
            if (data.success) {
                resultDiv.className = 'message message-success';
                resultDiv.innerHTML = '<strong><?= $block->escapeJs(__('Connection Successful!')) ?></strong>' +
                    (data.agent_name ? '<br>Agent: ' + data.agent_name : '');
            } else {
                resultDiv.className = 'message message-error';
                resultDiv.innerHTML = '<strong><?= $block->escapeJs(__('Connection Failed')) ?></strong><br>' +
                    (data.error || '<?= $block->escapeJs(__('Unknown error')) ?>');
            }
        })
        .catch(error => {
            resultDiv.style.display = 'block';
            resultDiv.className = 'message message-error';
            resultDiv.innerHTML = '<strong><?= $block->escapeJs(__('Request Failed')) ?></strong><br>' + error.message;
        })
        .finally(() => {
            btn.disabled = false;
            btn.querySelector('span').textContent = '<?= $block->escapeJs(__('Test Connection')) ?>';
        });
    }

    function syncProducts() {
        var btn = document.getElementById('requestdesk-sync-btn');
        var resultDiv = document.getElementById('sync-result');

        if (!confirm('<?= $block->escapeJs(__('This will sync all %1 products to RequestDesk. Continue?', $productCount)) ?>')) {
            return;
        }

        btn.disabled = true;
        btn.querySelector('span').textContent = '<?= $block->escapeJs(__('Syncing...')) ?>';
        resultDiv.style.display = 'block';
        resultDiv.className = 'message message-info';
        resultDiv.innerHTML = '<?= $block->escapeJs(__('Syncing products... This may take a few minutes.')) ?>';

        fetch('<?= $block->escapeUrl($block->getSyncUrl()) ?>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.className = 'message message-success';
                resultDiv.innerHTML = '<strong><?= $block->escapeJs(__('Sync Complete!')) ?></strong><br>' +
                    '<?= $block->escapeJs(__('Products synced:')) ?> ' + (data.total_synced || 0) +
                    (data.collection_id ? '<br><?= $block->escapeJs(__('Collection ID:')) ?> ' + data.collection_id : '');
            } else {
                resultDiv.className = 'message message-error';
                resultDiv.innerHTML = '<strong><?= $block->escapeJs(__('Sync Failed')) ?></strong><br>' +
                    (data.error || '<?= $block->escapeJs(__('Unknown error')) ?>');
            }
        })
        .catch(error => {
            resultDiv.className = 'message message-error';
            resultDiv.innerHTML = '<strong><?= $block->escapeJs(__('Request Failed')) ?></strong><br>' + error.message;
        })
        .finally(() => {
            btn.disabled = false;
            btn.querySelector('span').textContent = '<?= $block->escapeJs(__('Sync All Products')) ?>';
        });
    }
</script>

<style>
    .requestdesk-sync-container {
        max-width: 900px;
    }
    .requestdesk-sync-container .admin__page-section {
        background: #fff;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .requestdesk-sync-container .admin__page-section-title {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .requestdesk-sync-container .admin__page-section-title .title {
        font-size: 18px;
        font-weight: 600;
    }
    .requestdesk-sync-container .admin__field {
        margin-bottom: 15px;
    }
    .requestdesk-sync-container .admin__field-label {
        font-weight: 600;
        margin-bottom: 5px;
    }
    .requestdesk-sync-container .actions-toolbar {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    .requestdesk-sync-container .actions-toolbar .primary {
        display: flex;
        gap: 10px;
    }
</style>
